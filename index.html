<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BalanceChain Explorer</title>
  <meta name="color-scheme" content="dark light">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0c1730;
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --muted2:rgba(234,240,255,.55);
      --good:#2fe67c;
      --bad:#ff4d4d;
      --warn:#ffcc66;
      --accent:#6aa8ff;
      --accent2:#8f6aff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8ff;
        --panel:#ffffff;
        --panel2:#fbfcff;
        --border:rgba(10,20,40,.10);
        --text:#0b1220;
        --muted:rgba(11,18,32,.70);
        --muted2:rgba(11,18,32,.55);
        --shadow: 0 10px 28px rgba(10,20,40,.10);
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1000px 700px at 20% -10%, rgba(106,168,255,.18), transparent 60%),
        radial-gradient(900px 650px at 90% 0%, rgba(143,106,255,.14), transparent 55%),
        radial-gradient(800px 600px at 50% 110%, rgba(47,230,124,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
    header{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:16px;
    }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(255,255,255,.03);
      box-shadow:var(--shadow);
      font-size:12px;color:var(--muted);
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:15px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .mono{font-family:var(--mono)}
    .ok{color:var(--good);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .warn{color:var(--warn);font-weight:700}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.space{justify-content:space-between}
    .stack{display:flex;flex-direction:column;gap:8px}

    textarea, input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.45)}
    @media (prefers-color-scheme: light){
      input::placeholder, textarea::placeholder{color:rgba(10,20,40,.35)}
    }

    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(106,168,255,.22), rgba(106,168,255,.08));
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      letter-spacing:.15px;
      transition:transform .05s ease, filter .2s ease;
      user-select:none;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.secondary{
      background:rgba(255,255,255,.03);
      font-weight:600;
    }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:6px 12px;
      margin-top:10px;
      font-size:14px;
    }
    .kv b{color:var(--muted)}
    .kv span{word-break:break-word}

    details{
      border-top:1px dashed var(--border);
      margin-top:12px;
      padding-top:10px;
    }
    summary{cursor:pointer;color:var(--muted);font-weight:700}
    summary::-webkit-details-marker{display:none}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.02);
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
      font-size:14px;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.9px;
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    tr:last-child td{border-bottom:none}
    tr:hover td{background:rgba(255,255,255,.02)}
    .click{cursor:pointer}
    .right{text-align:right}
    .small{font-size:12px}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 640px){
      .split{grid-template-columns:1fr}
    }

    /* Graph UI */
    .bars{display:flex;flex-direction:column;gap:8px}
    .barRow{display:grid;grid-template-columns: 160px 1fr 70px;gap:10px;align-items:center}
    .barTrack{height:12px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:rgba(255,255,255,.02)}
    .barFill{height:100%;background:linear-gradient(90deg, rgba(106,168,255,.55), rgba(143,106,255,.45));}
    .gridHeat{
      display:grid;
      gap:8px;
      margin-top:10px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.02);
      padding:12px;
    }
    .heatCell{
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      background:rgba(255,255,255,.02);
      font-size:12px;
    }
    .pillMini{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:12px;
      margin-right:8px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>BalanceChain Explorer</h1>
      <div class="subtitle">State-only explorer (accounts + segments). Cross-node compare, serial lookup, account summary.</div>
    </div>
    <div class="pill" id="topPill">
      <span class="dot warn"></span>
      <span id="topStatus">Auto-loading…</span>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Node Endpoints</h2>
      <div class="muted small">
        Add extra nodes here (optional). When you click <b>Load Dashboard</b>, the first one becomes <b>Primary</b>.
      </div>

      <!-- ✅ DEFAULT PRIMARY LABEL REMOVED COMPLETELY (hidden hardcoded) -->

      <div style="margin-top:10px">
        <textarea id="nodes" spellcheck="false"
          placeholder="(Optional) Add endpoints here…
Example:
https://another-node.workers.dev
https://backup-node.workers.dev"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="load">Load Dashboard</button>
        <button class="secondary" id="reset">Reset to Default</button>
        <button class="secondary" id="quickTest">Quick Test</button>
        <span class="muted" id="status"></span>
      </div>

      <div id="health" style="margin-top:12px"></div>
    </div>

    <div class="card" id="global">
      <h2>Network Summary</h2>
      <div class="muted">Auto-loading default primary…</div>
    </div>
  </div>

  <div class="split" style="margin-top:14px">
    <div class="card">
      <h2>Serial Lookup</h2>
      <div class="muted small">Checks the latest owner state for a given (origin_account_id, segment_no) across all nodes.</div>
      <div class="row" style="margin-top:10px">
        <input id="serialOrigin" placeholder="origin_account_id" />
        <input id="serialNo" style="max-width:180px" placeholder="segment_no" />
        <button id="serialBtn">Lookup</button>
      </div>
      <div id="serialOut" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h2>Account Summary</h2>
      <div class="muted small">Shows account registry info + owned segment count (state snapshot).</div>
      <div class="row" style="margin-top:10px">
        <input id="accountSearch" placeholder="account_id" />
        <button id="viewAccount">View</button>
      </div>
      <div id="account" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row space">
      <div>
        <h2 style="margin:0">Accounts</h2>
        <div class="muted small">Accounts are listed from the primary node; other nodes are used only for mismatch detection.</div>
      </div>
      <div class="row">
        <button class="secondary" id="prev">Prev</button>
        <button class="secondary" id="next">Next</button>
        <span class="tag">cursor: <span id="cursor" class="mono">0</span> · limit: <span id="limit" class="mono">50</span></span>
      </div>
    </div>

    <div style="margin-top:12px">
      <table id="tbl">
        <thead>
          <tr>
            <th>account_id</th>
            <th>created</th>
            <th>updated</th>
            <th class="right">mismatches</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="muted2 small" style="margin-top:10px">
        Tip: click a row to open account summary.
      </div>
    </div>
  </div>

  <!-- ✅ Segment Ownership Graph -->
  <div class="card" style="margin-top:14px">
    <div class="row space">
      <div>
        <h2 style="margin:0">Segment Ownership Graph</h2>
        <div class="muted small">Origin → current owner map · owner distribution · heat matrix · top holders</div>
      </div>
      <div class="row">
        <button class="secondary" id="refreshSegments">Refresh</button>
        <span class="tag">segments loaded: <span id="segCount" class="mono">0</span></span>
      </div>
    </div>

    <div id="segStatus" class="muted2 small" style="margin-top:10px">Waiting…</div>

    <div class="split" style="margin-top:12px">
      <div>
        <div class="pillMini"><b class="muted">Top holders</b></div>
        <div id="leaders" style="margin-top:10px"></div>
      </div>

      <div>
        <div class="pillMini"><b class="muted">Owner distribution</b></div>
        <div id="dist" style="margin-top:10px"></div>
      </div>
    </div>

    <details style="margin-top:14px" open>
      <summary>Origin → Current owner map</summary>
      <div id="originMap" style="margin-top:10px"></div>
    </details>

    <details style="margin-top:14px">
      <summary>Heat matrix (origin x current_owner)</summary>
      <div id="heat" class="gridHeat"></div>
    </details>

    <details style="margin-top:14px">
      <summary>Raw segments (primary)</summary>
      <pre id="rawSeg" class="mono" style="margin-top:10px;white-space:pre-wrap;color:var(--muted)"></pre>
    </details>
  </div>

</div>

<script>
/** ✅ HARD CODED DEFAULT PRIMARY (fully hidden) */
const DEFAULT_PRIMARY = "https://balancechain-node.rr-rshemodel.workers.dev";

let cursor = 0;
let limit = 50;

const $ = (id)=>document.getElementById(id);

function setTop(status, kind){
  const pill = $('topPill');
  const dot = pill.querySelector('.dot');
  dot.className = 'dot ' + (kind || 'warn');
  $('topStatus').textContent = status;
}

function fmtMs(ms){
  if(ms===null || ms===undefined || ms==="") return "";
  const n = Number(ms);
  if(!Number.isFinite(n)) return String(ms);
  try { return new Date(n).toISOString(); } catch { return String(ms); }
}

function normNode(u){
  return u.trim().replace(/\/+$/,'');
}

function getUserNodes(){
  const lines = ($('nodes').value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return [...new Set(lines.map(normNode))];
}

/**
 * ✅ RULE:
 * - Page load => DEFAULT_PRIMARY is primary (auto load)
 * - If user adds endpoints + clicks Load => FIRST user endpoint becomes primary
 *   and DEFAULT_PRIMARY becomes cross-check node automatically.
 */
function computeNodes(){
  const user = getUserNodes();
  if(user.length === 0) return [DEFAULT_PRIMARY];

  const primary = user[0];
  const rest = user.slice(1);

  const nodes = [primary, ...rest];
  if(primary !== DEFAULT_PRIMARY && !nodes.includes(DEFAULT_PRIMARY)){
    nodes.push(DEFAULT_PRIMARY);
  }
  return nodes;
}

async function api(node, path){
  const u = node + path;
  const r = await fetch(u);
  let j;
  try { j = await r.json(); } catch { throw new Error(`Non-JSON from ${u}`); }
  if(!j.ok) throw new Error(j.error || `API error from ${u}`);
  return j;
}

async function safeApi(node, path){
  try { return { ok:true, data: await api(node, path) }; }
  catch (e) { return { ok:false, error:String(e.message||e) }; }
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function renderHealth(health){
  const el = $('health');
  if(health.length===0){
    el.innerHTML = '<div class="muted">No nodes.</div>';
    return;
  }
  const rows = health.map((h,i)=> {
    const role = (i===0) ? `<span class="ok">PRIMARY</span>` : `<span class="muted2">CHECK</span>`;
    const st = h.ok ? `<span class="ok">OK</span>` : `<span class="bad">DOWN</span>`;
    const meta = h.ok
      ? `<span class="muted">genesis ${fmtMs(h.data.genesis_utc_ms)} · chain <span class="mono">${h.data.chain_id}</span> · schema <span class="mono">${h.data.schema}</span></span>`
      : `<span class="muted">${escapeHtml(h.error)}</span>`;
    return `<div class="mono">${role} · ${st} ${escapeHtml(h.node)} <span style="margin-left:8px">${meta}</span></div>`;
  }).join('');
  el.innerHTML = `<details open><summary>Node health</summary><div style="margin-top:10px">${rows}</div></details>`;
}

function countMismatchesById(primaryList, otherLists){
  const mismById = new Map();
  const primSet = new Set(primaryList.map(a=>a.account_id));
  for(const a of primaryList) mismById.set(a.account_id, 0);
  for(const other of otherLists){
    const set = new Set((other||[]).map(a=>a.account_id));
    for(const id of primSet){
      if(!set.has(id)){
        mismById.set(id, (mismById.get(id)||0) + 1);
      }
    }
  }
  return mismById;
}

async function loadDashboard(){
  const nodes = computeNodes();
  $('status').textContent = 'Loading...';
  setTop('Loading…', 'warn');

  const health = await Promise.all(nodes.map(async (n)=> {
    const r = await safeApi(n, '/v1/node/info');
    if(r.ok) return { node:n, ok:true, data:r.data };
    return { node:n, ok:false, error:r.error };
  }));
  renderHealth(health);

  const stats = await Promise.all(nodes.map(async (n)=> ({ node:n, ...(await safeApi(n, '/v1/explorer/stats')) })));
  const primary = stats[0];

  if(!primary.ok){
    $('global').innerHTML = `<h2>Network Summary</h2><div class="bad">Primary node is down</div><div class="muted">${escapeHtml(primary.error)}</div>`;
    $('status').textContent = '';
    setTop('Primary down', 'bad');
    return;
  }

  const otherOk = stats.slice(1).filter(s=>s.ok).map(s=>s.data);
  const mism = otherOk.filter(s=>
    s.total_accounts !== primary.data.total_accounts ||
    s.total_segments !== primary.data.total_segments ||
    s.genesis_utc_ms !== primary.data.genesis_utc_ms
  ).length;

  $('global').innerHTML = `
    <h2>Network Summary</h2>
    <div class="kv">
      <b>Primary node</b> <span class="mono">${escapeHtml(primary.node)}</span>
      <b>chain_id</b> <span class="mono">${escapeHtml(primary.data.chain_id)}</span>
      <b>genesis</b> <span class="mono">${escapeHtml(fmtMs(primary.data.genesis_utc_ms))}</span>
      <b>accounts</b> <span>${primary.data.total_accounts} ${mism ? `<span class="bad"> · mismatch on ${mism} node(s)</span>` : `<span class="ok"> · consistent</span>`}</span>
      <b>segments</b> <span>${primary.data.total_segments}</span>
      <b>now</b> <span class="mono">${escapeHtml(fmtMs(primary.data.now_ms))}</span>
      <b>caps</b> <span class="mono">initial ${primary.data.initial_unlocked} · yearly ${primary.data.yearly_cap}</span>
    </div>
    <details>
      <summary>Raw primary stats</summary>
      <pre class="mono" style="margin-top:10px;white-space:pre-wrap;color:var(--muted)">${escapeHtml(JSON.stringify(primary.data,null,2))}</pre>
    </details>
  `;

  cursor = 0;
  await loadAccounts();

  $('status').textContent = 'OK';
  setTop('Healthy', 'ok');

  // auto refresh ownership graph
  await refreshSegments();
}

async function loadAccounts(){
  const nodes = computeNodes();
  $('cursor').textContent = String(cursor);
  $('limit').textContent = String(limit);

  const page = await Promise.all(nodes.map(async (n)=> ({ node:n, ...(await safeApi(n, `/v1/explorer/accounts?limit=${limit}&cursor=${cursor}`)) })));
  const primary = page[0];
  const tbody = $('tbl').querySelector('tbody');
  tbody.innerHTML = '';

  if(!primary.ok){
    tbody.innerHTML = `<tr><td colspan="4" class="bad">Primary node error: ${escapeHtml(primary.error)}</td></tr>`;
    return;
  }

  const primaryAccounts = primary.data.accounts || primary.data.results || [];
  const otherLists = page.slice(1).filter(p=>p.ok).map(p => (p.data.accounts || p.data.results || []));
  const mismById = countMismatchesById(primaryAccounts, otherLists);

  if(primaryAccounts.length === 0){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">No accounts yet.</td></tr>`;
    return;
  }

  for(const a of primaryAccounts){
    const id = a.account_id;
    const mism = mismById.get(id) || 0;

    const tr = document.createElement('tr');
    tr.className = 'click';
    tr.innerHTML = `
      <td class="mono">${escapeHtml(id)}</td>
      <td class="mono">${escapeHtml(fmtMs(a.created_at_ms))}</td>
      <td class="mono">${escapeHtml(fmtMs(a.updated_at_ms))}</td>
      <td class="right">${mism ? `<span class="bad">${mism}</span>` : `<span class="ok">0</span>`}</td>
    `;
    tr.onclick = ()=>viewAccount(id);
    tbody.appendChild(tr);
  }
}

async function viewAccount(accountId){
  const nodes = computeNodes();
  if(!accountId){ $('account').innerHTML=''; return; }

  $('account').innerHTML = `<div class="muted">Loading…</div>`;

  const results = await Promise.all(nodes.map(async (n)=> ({ node:n, ...(await safeApi(n, `/v1/explorer/accounts/${encodeURIComponent(accountId)}/summary`)) })));

  const okSummaries = results.filter(r=>r.ok).map(r=>r.data);
  const mism = (okSummaries.length > 1)
    ? okSummaries.slice(1).filter(x => JSON.stringify(x) !== JSON.stringify(okSummaries[0])).length
    : 0;

  const rows = results.map(r=>{
    if(!r.ok){
      return `<div class="mono"><span class="bad">DOWN</span> ${escapeHtml(r.node)} <span class="muted">${escapeHtml(r.error)}</span></div>`;
    }
    const s = r.data;
    const acc = s.account || {};
    return `
      <div class="mono">
        <span class="ok">OK</span> ${escapeHtml(r.node)}
        <span class="muted">
          · owned_segments=${escapeHtml(String(s.owned_segments ?? 0))}
          · created=${escapeHtml(fmtMs(acc.created_at_ms))}
          · updated=${escapeHtml(fmtMs(acc.updated_at_ms))}
        </span>
      </div>
    `;
  }).join('');

  $('account').innerHTML = `
    <div><b>account_id:</b> <span class="mono">${escapeHtml(accountId)}</span>
      ${mism ? `<span class="bad"> · mismatch on ${mism} node(s)</span>` : `<span class="ok"> · consistent</span>`}
    </div>
    <details open>
      <summary>Across nodes</summary>
      <div style="margin-top:10px">${rows}</div>
    </details>
  `;
}

async function lookupSerial(){
  const nodes = computeNodes();
  const origin = $('serialOrigin').value.trim();
  const no = $('serialNo').value.trim();

  if(!origin || no===''){
    $('serialOut').innerHTML = '<span class="muted">Enter origin_account_id and segment_no</span>';
    return;
  }

  $('serialOut').innerHTML = `<div class="muted">Loading…</div>`;

  const path = `/v1/explorer/serial?origin_account_id=${encodeURIComponent(origin)}&segment_no=${encodeURIComponent(no)}`;
  const results = await Promise.all(nodes.map(async (n)=> ({ node:n, ...(await safeApi(n, path)) })));

  const found = results.filter(r=>r.ok && r.data.segment).map(r=>r.data.segment);
  let mism = 0;
  if(found.length > 1){
    const p = found[0];
    mism = found.slice(1).filter(s=>
      s.current_account_id !== p.current_account_id ||
      s.previous_account_id !== p.previous_account_id ||
      s.counter !== p.counter ||
      s.last_utc_ms !== p.last_utc_ms
    ).length;
  }

  const rows = results.map(r=>{
    if(!r.ok){
      return `<div class="mono"><span class="bad">DOWN</span> ${escapeHtml(r.node)} <span class="muted">${escapeHtml(r.error)}</span></div>`;
    }
    const seg = r.data.segment;
    if(!seg){
      return `<div class="mono"><span class="warn">MISS</span> ${escapeHtml(r.node)} <span class="muted">segment not found</span></div>`;
    }
    return `
      <div class="mono">
        <span class="ok">OK</span> ${escapeHtml(r.node)}
        <span class="muted">
          · prev=${escapeHtml(seg.previous_account_id)}
          · curr=${escapeHtml(seg.current_account_id)}
          · utc=${escapeHtml(fmtMs(seg.last_utc_ms))}
          · ctr=${escapeHtml(String(seg.counter))}
        </span>
      </div>
    `;
  }).join('');

  $('serialOut').innerHTML = `
    <div><b>Serial:</b> <span class="mono">(${escapeHtml(origin)}, ${escapeHtml(no)})</span>
      ${mism ? `<span class="bad"> · mismatch on ${mism} node(s)</span>` : `<span class="ok"> · consistent</span>`}
    </div>
    <details open>
      <summary>Across nodes</summary>
      <div style="margin-top:10px">${rows}</div>
    </details>
  `;
}

async function quickTest(){
  const nodes = computeNodes();
  setTop('Testing…', 'warn');
  const r = await safeApi(nodes[0], '/v1/node/info');
  if(r.ok) setTop('Primary reachable', 'ok');
  else setTop('Primary failed', 'bad');
}

/** -------- Segment Ownership Graph -------- */

function normalizeSegmentsPayload(j){
  // Support: {segments:[...]} or {results:[...]}
  const segs = j.segments || j.results || [];
  return Array.isArray(segs) ? segs : [];
}

async function fetchAllSegments(primaryNode, totalHint){
  // Best-effort paginator for /v1/explorer/segments
  // Tries until empty page or cursor stops advancing.
  const out = [];
  const pageLimit = 500;
  let cur = 0;
  let loops = 0;

  while(loops < 50){
    loops++;
    const r = await safeApi(primaryNode, `/v1/explorer/segments?limit=${pageLimit}&cursor=${cur}`);
    if(!r.ok){
      // if endpoint doesn't exist, throw to show clear UI message
      throw new Error(r.error || "segments endpoint failed");
    }
    const segs = normalizeSegmentsPayload(r.data);
    if(segs.length === 0) break;
    out.push(...segs);

    // next cursor support
    const next = r.data.next_cursor;
    if(next === undefined || next === null){
      // no cursor info => stop after first page
      break;
    }
    if(Number(next) === Number(cur)) break;
    cur = Number(next);

    if(totalHint && out.length >= totalHint) break;
  }

  return out;
}

function buildOwnershipAnalytics(segments){
  // Expected fields per segment:
  // origin_account_id, segment_no, current_account_id, previous_account_id, last_utc_ms, counter
  const byOwner = new Map();
  const byOrigin = new Map();
  const origins = new Set();
  const owners = new Set();

  for(const s of segments){
    const o = String(s.origin_account_id ?? "");
    const curr = String(s.current_account_id ?? "");
    if(!o || !curr) continue;

    origins.add(o);
    owners.add(curr);

    byOwner.set(curr, (byOwner.get(curr)||0) + 1);

    if(!byOrigin.has(o)) byOrigin.set(o, []);
    byOrigin.get(o).push(s);
  }

  // Heat matrix: origin x owner counts
  const originList = [...origins].sort();
  const ownerList = [...owners].sort();
  const heat = new Map(); // key `${origin}||${owner}` -> count
  for(const s of segments){
    const o = String(s.origin_account_id ?? "");
    const curr = String(s.current_account_id ?? "");
    if(!o || !curr) continue;
    const k = o + "||" + curr;
    heat.set(k, (heat.get(k)||0) + 1);
  }

  const leaders = [...byOwner.entries()].sort((a,b)=>b[1]-a[1]);

  return { byOwner, byOrigin, originList, ownerList, heat, leaders };
}

function renderLeaders(leaders){
  if(leaders.length === 0){
    $('leaders').innerHTML = `<div class="muted">No owner data.</div>`;
    return;
  }
  const top = leaders.slice(0,10);
  const rows = top.map(([id,count],i)=>`
    <div class="mono" style="padding:8px 0;border-bottom:1px dashed var(--border)">
      <span class="muted2">#${i+1}</span> <b>${escapeHtml(id)}</b>
      <span class="muted2"> · segments</span> <span class="ok">${count}</span>
    </div>
  `).join('');
  $('leaders').innerHTML = `<div>${rows}</div>`;
}

function renderDistribution(byOwner){
  const entries = [...byOwner.entries()].sort((a,b)=>b[1]-a[1]);
  if(entries.length === 0){
    $('dist').innerHTML = `<div class="muted">No distribution data.</div>`;
    return;
  }
  const max = entries[0][1] || 1;

  const bars = entries.slice(0,12).map(([id,count])=>{
    const pct = Math.max(2, Math.round((count/max)*100));
    return `
      <div class="barRow">
        <div class="mono">${escapeHtml(id)}</div>
        <div class="barTrack"><div class="barFill" style="width:${pct}%"></div></div>
        <div class="mono right">${count}</div>
      </div>
    `;
  }).join('');

  $('dist').innerHTML = `<div class="bars">${bars}</div>`;
}

function renderOriginMap(byOrigin){
  const origins = [...byOrigin.keys()].sort();
  if(origins.length === 0){
    $('originMap').innerHTML = `<div class="muted">No origin map data.</div>`;
    return;
  }

  const blocks = origins.map(origin=>{
    const segs = byOrigin.get(origin).slice().sort((a,b)=>(a.segment_no??0)-(b.segment_no??0));
    const lines = segs.map(s=>{
      const sn = s.segment_no ?? "?";
      const prev = s.previous_account_id ?? "—";
      const curr = s.current_account_id ?? "—";
      const utc = fmtMs(s.last_utc_ms);
      const ctr = s.counter ?? 0;
      return `<div class="mono muted2">seg ${escapeHtml(String(sn))}: <span class="muted2">prev</span> ${escapeHtml(String(prev))} → <span class="ok">curr</span> ${escapeHtml(String(curr))} <span class="muted2">· ctr</span> ${escapeHtml(String(ctr))} <span class="muted2">·</span> ${escapeHtml(String(utc||""))}</div>`;
    }).join("");

    return `
      <div style="padding:12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.02);margin-bottom:10px">
        <div class="mono"><b>Origin:</b> ${escapeHtml(origin)} <span class="muted2">· segments</span> <span class="ok">${segs.length}</span></div>
        <div style="margin-top:8px">${lines}</div>
      </div>
    `;
  }).join("");

  $('originMap').innerHTML = blocks;
}

function renderHeatMatrix(originList, ownerList, heat){
  const container = $('heat');
  container.innerHTML = "";

  if(originList.length === 0 || ownerList.length === 0){
    container.innerHTML = `<div class="muted">No heat data.</div>`;
    return;
  }

  // Build a compact matrix: each origin row shows owners with counts > 0
  const rows = originList.map(origin=>{
    const hits = ownerList
      .map(owner=>({ owner, count: heat.get(origin+"||"+owner) || 0 }))
      .filter(x=>x.count>0)
      .sort((a,b)=>b.count-a.count);

    const cells = (hits.length ? hits : [{owner:"(none)",count:0}]).slice(0,12).map(x=>`
      <div class="heatCell">
        <div class="mono"><b>${escapeHtml(origin)}</b> → ${escapeHtml(x.owner)}</div>
        <div class="mono muted2">count: <span class="ok">${x.count}</span></div>
      </div>
    `).join("");

    return cells;
  }).join("");

  // dynamic columns
  container.style.gridTemplateColumns = "repeat(auto-fit, minmax(240px, 1fr))";
  container.innerHTML = rows;
}

async function refreshSegments(){
  const nodes = computeNodes();
  const primary = nodes[0];

  $('segStatus').textContent = "Loading segments from primary…";
  $('segCount').textContent = "0";
  $('leaders').innerHTML = "";
  $('dist').innerHTML = "";
  $('originMap').innerHTML = "";
  $('heat').innerHTML = "";
  $('rawSeg').textContent = "";

  // Get total hint (optional)
  const stats = await safeApi(primary, "/v1/explorer/stats");
  const totalHint = (stats.ok && Number.isFinite(Number(stats.data.total_segments))) ? Number(stats.data.total_segments) : null;

  try{
    const segs = await fetchAllSegments(primary, totalHint);
    $('segCount').textContent = String(segs.length);

    $('rawSeg').textContent = JSON.stringify(segs.slice(0,200), null, 2) + (segs.length>200 ? "\n\n…(truncated)" : "");

    $('segStatus').innerHTML = `<span class="ok">OK</span> Loaded ${segs.length} segment(s) from <span class="mono">${escapeHtml(primary)}</span>`;

    const a = buildOwnershipAnalytics(segs);
    renderLeaders(a.leaders);
    renderDistribution(a.byOwner);
    renderOriginMap(a.byOrigin);
    renderHeatMatrix(a.originList, a.ownerList, a.heat);

  }catch(e){
    $('segStatus').innerHTML = `<span class="bad">Segments not available</span> · ${escapeHtml(String(e.message||e))}<div class="muted2 small" style="margin-top:6px">Expected endpoint: <span class="mono">/v1/explorer/segments</span>. If yours differs, tell me the real path and I’ll wire it.</div>`;
  }
}

/** Buttons */
$('load').onclick = loadDashboard;
$('quickTest').onclick = quickTest;
$('reset').onclick = async ()=>{
  $('nodes').value = "";
  cursor = 0;
  await loadDashboard();
};
$('next').onclick = async ()=>{ cursor += limit; await loadAccounts(); };
$('prev').onclick = async ()=>{ cursor = Math.max(0, cursor - limit); await loadAccounts(); };
$('viewAccount').onclick = ()=>viewAccount($('accountSearch').value.trim());
$('serialBtn').onclick = lookupSerial;
$('refreshSegments').onclick = refreshSegments;

/** Auto-load on open */
window.addEventListener("DOMContentLoaded", async ()=>{
  await loadDashboard();
});
</script>
</body>
</html>
