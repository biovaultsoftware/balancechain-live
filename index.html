<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BalanceChain Explorer</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0c1730;
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --muted2:rgba(234,240,255,.55);
      --good:#2fe67c;
      --bad:#ff4d4d;
      --warn:#ffcc66;
      --accent:#6aa8ff;
      --accent2:#8f6aff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8ff;
        --panel:#ffffff;
        --panel2:#fbfcff;
        --border:rgba(10,20,40,.10);
        --text:#0b1220;
        --muted:rgba(11,18,32,.70);
        --muted2:rgba(11,18,32,.55);
        --shadow: 0 10px 28px rgba(10,20,40,.10);
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1000px 700px at 20% -10%, rgba(106,168,255,.18), transparent 60%),
        radial-gradient(900px 650px at 90% 0%, rgba(143,106,255,.14), transparent 55%),
        radial-gradient(800px 600px at 50% 110%, rgba(47,230,124,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1280px;margin:28px auto;padding:0 18px}
    header{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:16px;
    }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px;max-width:950px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(255,255,255,.03);
      box-shadow:var(--shadow);
      font-size:12px;color:var(--muted);
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:15px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .mono{font-family:var(--mono)}
    .ok{color:var(--good);font-weight:800}
    .bad{color:var(--bad);font-weight:800}
    .warn{color:var(--warn);font-weight:800}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.space{justify-content:space-between}
    .stack{display:flex;flex-direction:column;gap:8px}

    textarea, input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.45)}
    @media (prefers-color-scheme: light){
      input::placeholder, textarea::placeholder{color:rgba(10,20,40,.35)}
    }

    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(106,168,255,.22), rgba(106,168,255,.08));
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      letter-spacing:.15px;
      transition:transform .05s ease, filter .2s ease;
      user-select:none;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.secondary{
      background:rgba(255,255,255,.03);
      font-weight:700;
    }
    button.danger{
      background:linear-gradient(180deg, rgba(255,77,77,.18), rgba(255,77,77,.06));
    }

    .kv{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap:6px 12px;
      margin-top:10px;
      font-size:14px;
    }
    .kv b{color:var(--muted)}
    .kv span{word-break:break-word}

    details{
      border-top:1px dashed var(--border);
      margin-top:12px;
      padding-top:10px;
    }
    summary{cursor:pointer;color:var(--muted);font-weight:800}
    summary::-webkit-details-marker{display:none}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.02);
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
      font-size:14px;
    }
    th{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.9px;
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    tr:last-child td{border-bottom:none}
    tr:hover td{background:rgba(255,255,255,.02)}
    .click{cursor:pointer}
    .right{text-align:right}
    .small{font-size:12px}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 820px){
      .split{grid-template-columns:1fr}
    }

    .hint{
      padding:10px 12px;border:1px solid var(--border);
      border-radius:12px;background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* we purposely DO NOT show the hardcoded primary anywhere */
    .hiddenPrimaryNote{display:none !important}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>BalanceChain Explorer</h1>
      <div class="subtitle">
        State-only explorer (accounts + segments). Shows <b>unlocked vs expected vs remaining + next unlock</b>. Optional cross-check nodes.
      </div>
    </div>
    <div class="pill" id="topPill">
      <span class="dot warn"></span>
      <span id="topStatus">Loading…</span>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Extra Node Endpoints (optional)</h2>
      <div class="muted small">
        Add extra nodes here (one per line). The <b>primary</b> is hardcoded and auto-loaded.
        When you click <b>Load Dashboard</b>, we use: primary + these nodes for cross-check.
      </div>

      <div style="margin-top:10px">
        <textarea id="nodesExtra" spellcheck="false" placeholder="(Optional) add endpoints here…
Example:
https://another-node.workers.dev
https://backup-node.workers.dev"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="load">Load Dashboard</button>
        <button class="secondary" id="quickTest">Quick Test</button>
        <button class="secondary" id="reset">Reset Extras</button>
        <span class="muted" id="status"></span>
      </div>

      <div id="health" style="margin-top:12px"></div>
    </div>

    <div class="card" id="global">
      <h2>Network Summary</h2>
      <div class="muted">Auto-loading…</div>
    </div>
  </div>

  <div class="split" style="margin-top:14px">
    <div class="card">
      <h2>Serial Lookup</h2>
      <div class="muted small">Checks latest owner state for (origin_account_id, segment_no) across nodes.</div>
      <div class="row" style="margin-top:10px">
        <input id="serialOrigin" placeholder="origin_account_id" />
        <input id="serialNo" style="max-width:180px" placeholder="segment_no" />
        <button id="serialBtn">Lookup</button>
      </div>
      <div id="serialOut" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h2>Account Summary</h2>
      <div class="muted small">Shows unlocked vs expected vs remaining + next unlock time (computed by node).</div>
      <div class="row" style="margin-top:10px">
        <input id="accountSearch" placeholder="account_id" />
        <button id="viewAccount">View</button>
      </div>
      <div id="account" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row space">
      <div>
        <h2 style="margin:0">Accounts</h2>
        <div class="muted small">Listed from primary; extras are used only for mismatch detection.</div>
      </div>
      <div class="row">
        <button class="secondary" id="prev">Prev</button>
        <button class="secondary" id="next">Next</button>
        <span class="tag">cursor: <span id="cursor" class="mono">0</span> · limit: <span id="limit" class="mono">50</span></span>
      </div>
    </div>

    <div style="margin-top:12px">
      <table id="tbl">
        <thead>
          <tr>
            <th>account_id</th>
            <th class="right">unlocked</th>
            <th class="right">expected</th>
            <th class="right">remaining</th>
            <th>next unlock (UTC)</th>
            <th class="right">mismatches</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted2 small" style="margin-top:10px">Tip: click a row to open account summary.</div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row space">
      <div>
        <h2 style="margin:0">Segment Ownership Graph</h2>
        <div class="muted small">
          Origin → current owner map · owner distribution · top holders.
          <span class="muted2">(Requires node endpoint: <span class="mono">GET /v1/explorer/segments</span>)</span>
        </div>
      </div>
      <div class="row">
        <button class="secondary" id="graphRefresh">Refresh</button>
        <span class="tag">segments scanned: <span id="graphCount" class="mono">0</span></span>
      </div>
    </div>

    <div id="graphOut" class="hint" style="margin-top:12px">
      Loading graph…
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <h3 style="margin:0 0 8px 0;font-size:13px;color:var(--muted)">Top holders</h3>
        <table id="topHoldersTbl">
          <thead>
            <tr>
              <th>account_id</th>
              <th class="right">owned</th>
              <th class="right">% of scanned</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3 style="margin:0 0 8px 0;font-size:13px;color:var(--muted)">Origin → current owner (sample)</h3>
        <table id="originMapTbl">
          <thead>
            <tr>
              <th>origin</th>
              <th>current owner</th>
              <th class="right">count</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
/** ===========================
 *  PRIMARY (HARD CODED, INVISIBLE)
 *  =========================== */
const PRIMARY_NODE = "https://balancechain-node.rr-rshemodel.workers.dev"; // no trailing slash
const EXTRA_STORAGE_KEY = "balancechain_extras_v1";

let cursor = 0;
let limit = 50;

const $ = (id)=>document.getElementById(id);

function setTop(status, kind){
  const pill = $('topPill');
  const dot = pill.querySelector('.dot');
  dot.className = 'dot ' + (kind || 'warn');
  $('topStatus').textContent = status;
}

function fmtMs(ms){
  if(ms===null || ms===undefined || ms==="") return "";
  const n = Number(ms);
  if(!Number.isFinite(n)) return String(ms);
  try { return new Date(n).toISOString(); } catch { return String(ms); }
}

function normNode(u){
  return u.trim().replace(/\/+$/,'');
}

function loadExtrasFromStorage(){
  const raw = localStorage.getItem(EXTRA_STORAGE_KEY) || "";
  $('nodesExtra').value = raw;
}

function saveExtrasToStorage(){
  localStorage.setItem(EXTRA_STORAGE_KEY, $('nodesExtra').value || "");
}

function getNodes(){
  // primary always first (but never shown)
  const extra = ($('nodesExtra').value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const all = [PRIMARY_NODE, ...extra.map(normNode)];
  // de-dup while preserving order
  const out = [];
  const seen = new Set();
  for(const n of all){
    const k = normNode(n);
    if(!k) continue;
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(k);
  }
  return out;
}

async function api(node, path){
  const u = node + path;
  const r = await fetch(u);
  let j;
  try { j = await r.json(); } catch { throw new Error(`Non-JSON from ${u}`); }
  if(!j.ok) throw new Error(j.error || `API error from ${u}`);
  return j;
}

async function safeApi(node, path){
  try { return { ok:true, data: await api(node, path) }; }
  catch (e) { return { ok:false, error:String(e.message||e) }; }
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function renderHealth(health){
  const el = $('health');
  const rows = health.map((h, idx)=>{
    const st = h.ok ? `<span class="ok">OK</span>` : `<span class="bad">DOWN</span>`;
    const role = (idx===0) ? `<span class="ok">PRIMARY</span> · ` : ``;
    const meta = h.ok
      ? `<span class="muted">genesis ${fmtMs(h.data.genesis_utc_ms)} · chain <span class="mono">${h.data.chain_id}</span> · schema <span class="mono">${h.data.schema}</span></span>`
      : `<span class="muted">${escapeHtml(h.error)}</span>`;
    return `<div class="mono">${role}${st} ${escapeHtml(h.node)} <span style="margin-left:8px">${meta}</span></div>`;
  }).join('');

  el.innerHTML = `<details open><summary>Node health</summary><div style="margin-top:10px">${rows}</div></details>`;
}

function diffSummary(a, b){
  // strict compare of critical fields for mismatches
  if(!a || !b) return true;
  const keys = ["unlocked_segments_count","expected_allowed_to_date","remaining","next_unlock_utc_ms","reclaim_nonce"];
  for(const k of keys){
    if((a[k] ?? null) !== (b[k] ?? null)) return true;
  }
  return false;
}

async function loadDashboard(){
  saveExtrasToStorage();

  const nodes = getNodes();
  $('status').textContent = 'Loading…';
  setTop('Loading…', 'warn');

  const health = await Promise.all(nodes.map(async (n)=>{
    const r = await safeApi(n, '/v1/node/info');
    if(r.ok) return { node:n, ok:true, data:r.data };
    return { node:n, ok:false, error:r.error };
  }));
  renderHealth(health);

  const primaryHealth = health[0];
  if(!primaryHealth || !primaryHealth.ok){
    $('global').innerHTML = `<h2>Network Summary</h2>
      <div class="bad">Primary node is down</div>
      <div class="muted">${escapeHtml(primaryHealth?.error || "Unknown error")}</div>`;
    $('status').textContent = '';
    setTop('Primary down', 'bad');
    return;
  }

  const stats = await Promise.all(nodes.map(async (n)=>({ node:n, ...(await safeApi(n, '/v1/explorer/stats')) })));
  const primary = stats[0];

  if(!primary.ok){
    $('global').innerHTML = `<h2>Network Summary</h2><div class="bad">Primary stats failed</div><div class="muted">${escapeHtml(primary.error)}</div>`;
    $('status').textContent = '';
    setTop('Primary failed', 'bad');
    return;
  }

  const otherOk = stats.slice(1).filter(s=>s.ok).map(s=>s.data);
  const mism = otherOk.filter(s=>
    s.total_accounts !== primary.data.total_accounts ||
    s.total_segments !== primary.data.total_segments ||
    s.genesis_utc_ms !== primary.data.genesis_utc_ms
  ).length;

  $('global').innerHTML = `
    <h2>Network Summary</h2>
    <div class="kv">
      <b>chain_id</b> <span class="mono">${escapeHtml(primary.data.chain_id)}</span>
      <b>genesis</b> <span class="mono">${escapeHtml(fmtMs(primary.data.genesis_utc_ms))}</span>
      <b>accounts</b> <span>${escapeHtml(primary.data.total_accounts)} ${mism ? `<span class="bad"> · mismatch on ${mism} node(s)</span>` : `<span class="ok"> · consistent</span>`}</span>
      <b>segments</b> <span>${escapeHtml(primary.data.total_segments)}</span>
      <b>now</b> <span class="mono">${escapeHtml(fmtMs(primary.data.now_ms))}</span>
      <b>caps</b>
      <span class="mono">
        init ${escapeHtml(primary.data.caps?.initial ?? primary.data.initial_unlocked ?? "?")} ·
        day ${escapeHtml(primary.data.caps?.per_day ?? "?")} ·
        month ${escapeHtml(primary.data.caps?.per_month ?? "?")} ·
        year ${escapeHtml(primary.data.caps?.per_year ?? primary.data.yearly_cap ?? "?")}
      </span>
    </div>
    <details>
      <summary>Raw primary stats</summary>
      <pre class="mono" style="margin-top:10px;white-space:pre-wrap;color:var(--muted)">${escapeHtml(JSON.stringify(primary.data,null,2))}</pre>
    </details>
  `;

  cursor = 0;
  await loadAccounts();
  await refreshGraph(); // best-effort
  $('status').textContent = 'OK';
  setTop('Healthy', 'ok');
}

async function loadAccounts(){
  const nodes = getNodes();
  $('cursor').textContent = String(cursor);
  $('limit').textContent = String(limit);

  const page = await Promise.all(nodes.map(async (n)=>({ node:n, ...(await safeApi(n, `/v1/explorer/accounts?limit=${limit}&cursor=${cursor}`)) })));
  const primary = page[0];

  const tbody = $('tbl').querySelector('tbody');
  tbody.innerHTML = '';

  if(!primary.ok){
    tbody.innerHTML = `<tr><td colspan="6" class="bad">Primary node error: ${escapeHtml(primary.error)}</td></tr>`;
    return;
  }

  const primaryAccounts = primary.data.accounts || primary.data.results || [];
  if(primaryAccounts.length === 0){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">No accounts yet.</td></tr>`;
    return;
  }

  // Build other-node maps by account_id (for mismatch detection)
  const otherMaps = page.slice(1).map(p=>{
    if(!p.ok) return null;
    const list = p.data.accounts || p.data.results || [];
    const m = new Map();
    for(const a of list) m.set(a.account_id, a);
    return m;
  });

  for(const a of primaryAccounts){
    const id = a.account_id;
    const others = otherMaps.map(m => m ? m.get(id) : null);
    let mism = 0;
    for(const o of others){
      if(!o) continue;
      // Compare time-based fields if node returns them, otherwise compare what exists
      const keys = ["unlocked_segments_count","expected_allowed_to_date","remaining","next_unlock_utc_ms"];
      for(const k of keys){
        if((a[k] ?? null) !== (o[k] ?? null)){ mism++; break; }
      }
    }

    const tr = document.createElement('tr');
    tr.className = 'click';
    tr.innerHTML = `
      <td class="mono">${escapeHtml(id)}</td>
      <td class="right mono">${escapeHtml(a.unlocked_segments_count ?? "—")}</td>
      <td class="right mono">${escapeHtml(a.expected_allowed_to_date ?? "—")}</td>
      <td class="right mono">${escapeHtml(a.remaining ?? "—")}</td>
      <td class="mono">${escapeHtml(a.next_unlock_utc_ms ? fmtMs(a.next_unlock_utc_ms) : "—")}</td>
      <td class="right">${mism ? `<span class="bad">${mism}</span>` : `<span class="ok">0</span>`}</td>
    `;
    tr.onclick = ()=>viewAccount(id);
    tbody.appendChild(tr);
  }
}

async function viewAccount(accountId){
  const nodes = getNodes();
  if(!accountId){ $('account').innerHTML=''; return; }

  $('account').innerHTML = `<div class="muted">Loading…</div>`;
  const results = await Promise.all(nodes.map(async (n)=>({ node:n, ...(await safeApi(n, `/v1/explorer/accounts/${encodeURIComponent(accountId)}/summary`)) })));

  const okSummaries = results.filter(r=>r.ok).map(r=>r.data);
  let mism = 0;
  if(okSummaries.length > 1){
    const p = okSummaries[0];
    mism = okSummaries.slice(1).filter(x => diffSummary(p, x)).length;
  }

  const primary = results[0].ok ? results[0].data : null;

  const rows = results.map(r=>{
    if(!r.ok){
      return `<div class="mono"><span class="bad">DOWN</span> ${escapeHtml(r.node)} <span class="muted">${escapeHtml(r.error)}</span></div>`;
    }
    const s = r.data;
    return `
      <div class="mono">
        <span class="ok">OK</span> ${escapeHtml(r.node)}
        <span class="muted">
          · unlocked=${escapeHtml(s.unlocked_segments_count ?? "—")}
          · expected=${escapeHtml(s.expected_allowed_to_date ?? "—")}
          · remaining=${escapeHtml(s.remaining ?? "—")}
          · next=${escapeHtml(s.next_unlock_utc_ms ? fmtMs(s.next_unlock_utc_ms) : "—")}
        </span>
      </div>
    `;
  }).join('');

  $('account').innerHTML = `
    <div><b>account_id:</b> <span class="mono">${escapeHtml(accountId)}</span>
      ${mism ? `<span class="bad"> · mismatch on ${mism} node(s)</span>` : `<span class="ok"> · consistent</span>`}
    </div>

    ${primary ? `
      <div class="kv" style="margin-top:10px">
        <b>unlocked</b> <span class="mono">${escapeHtml(primary.unlocked_segments_count ?? "—")}</span>
        <b>expected</b> <span class="mono">${escapeHtml(primary.expected_allowed_to_date ?? "—")}</span>
        <b>remaining</b> <span class="mono">${escapeHtml(primary.remaining ?? "—")}</span>
        <b>next unlock</b> <span class="mono">${escapeHtml(primary.next_unlock_utc_ms ? fmtMs(primary.next_unlock_utc_ms) : "—")}</span>
        <b>join</b> <span class="mono">${escapeHtml(primary.join_utc_ms ? fmtMs(primary.join_utc_ms) : "—")}</span>
      </div>
    ` : ``}

    <details open>
      <summary>Across nodes</summary>
      <div style="margin-top:10px">${rows}</div>
    </details>
  `;
}

async function lookupSerial(){
  const nodes = getNodes();
  const origin = $('serialOrigin').value.trim();
  const no = $('serialNo').value.trim();
  if(!origin || no===''){
    $('serialOut').innerHTML = '<span class="muted">Enter origin_account_id and segment_no</span>';
    return;
  }
  $('serialOut').innerHTML = `<div class="muted">Loading…</div>`;

  const path = `/v1/explorer/serial?origin_account_id=${encodeURIComponent(origin)}&segment_no=${encodeURIComponent(no)}`;
  const results = await Promise.all(nodes.map(async (n)=>({ node:n, ...(await safeApi(n, path)) })));

  const found = results.filter(r=>r.ok && r.data.segment).map(r=>r.data.segment);
  let mism = 0;
  if(found.length > 1){
    const p = found[0];
    mism = found.slice(1).filter(s=>
      s.current_account_id !== p.current_account_id ||
      s.previous_account_id !== p.previous_account_id ||
      s.counter !== p.counter ||
      s.last_utc_ms !== p.last_utc_ms
    ).length;
  }

  const rows = results.map(r=>{
    if(!r.ok){
      return `<div class="mono"><span class="bad">DOWN</span> ${escapeHtml(r.node)} <span class="muted">${escapeHtml(r.error)}</span></div>`;
    }
    const seg = r.data.segment;
    if(!seg){
      return `<div class="mono"><span class="warn">MISS</span> ${escapeHtml(r.node)} <span class="muted">segment not found</span></div>`;
    }
    return `
      <div class="mono">
        <span class="ok">OK</span> ${escapeHtml(r.node)}
        <span class="muted">
          · prev=${escapeHtml(seg.previous_account_id)}
          · curr=${escapeHtml(seg.current_account_id)}
          · utc=${escapeHtml(fmtMs(seg.last_utc_ms))}
          · ctr=${escapeHtml(String(seg.counter))}
        </span>
      </div>
    `;
  }).join('');

  $('serialOut').innerHTML = `
    <div><b>Serial:</b> <span class="mono">(${escapeHtml(origin)}, ${escapeHtml(no)})</span>
      ${mism ? `<span class="bad"> · mismatch on ${mism} node(s)</span>` : `<span class="ok"> · consistent</span>`}
    </div>
    <details open>
      <summary>Across nodes</summary>
      <div style="margin-top:10px">${rows}</div>
    </details>
  `;
}

async function quickTest(){
  const nodes = getNodes();
  setTop('Testing…', 'warn');
  const r = await safeApi(nodes[0], '/v1/node/info');
  if(r.ok) setTop('Healthy', 'ok');
  else setTop('Primary failed', 'bad');
}

/** ===========================
 *  Segment Ownership Graph
 *  =========================== */
function renderTableBody(tbody, rowsHtml){
  tbody.innerHTML = rowsHtml || `<tr><td class="muted" colspan="3">No data</td></tr>`;
}

async function refreshGraph(){
  $('graphOut').textContent = 'Loading graph…';
  $('graphCount').textContent = '0';

  const nodes = getNodes();
  const primary = nodes[0];

  // We scan segments from node (best effort)
  // Requires Worker endpoint: GET /v1/explorer/segments?limit=...&cursor=...
  let cursor = 0;
  const limit = 500;         // scan in pages
  const maxPages = 20;       // up to 10k segments scanned max
  let scanned = 0;

  const ownerCount = new Map();                 // current_owner -> count
  const originToOwnerCount = new Map();         // "origin|owner" -> count

  for(let page=0; page<maxPages; page++){
    const res = await safeApi(primary, `/v1/explorer/segments?limit=${limit}&cursor=${cursor}`);
    if(!res.ok){
      $('graphOut').innerHTML = `
        <div><span class="bad">Graph unavailable.</span></div>
        <div class="muted">Your node does not expose <span class="mono">GET /v1/explorer/segments</span> yet.</div>
      `;
      renderTableBody($('topHoldersTbl').querySelector('tbody'), '');
      renderTableBody($('originMapTbl').querySelector('tbody'), '');
      return;
    }

    const segments = res.data.segments || res.data.results || [];
    if(!Array.isArray(segments) || segments.length === 0) break;

    for(const s of segments){
      const owner = s.current_account_id || "";
      const origin = s.origin_account_id || "";
      if(owner){
        ownerCount.set(owner, (ownerCount.get(owner)||0)+1);
      }
      if(origin && owner){
        const k = origin + "|" + owner;
        originToOwnerCount.set(k, (originToOwnerCount.get(k)||0)+1);
      }
      scanned++;
    }

    cursor = Number(res.data.next_cursor ?? (cursor + segments.length));
    if(!Number.isFinite(cursor)) break;
    if(segments.length < limit) break;
  }

  $('graphCount').textContent = String(scanned);

  if(scanned === 0){
    $('graphOut').innerHTML = `<div class="muted">No segments to graph yet.</div>`;
    renderTableBody($('topHoldersTbl').querySelector('tbody'), '');
    renderTableBody($('originMapTbl').querySelector('tbody'), '');
    return;
  }

  // Top holders
  const top = [...ownerCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 12);
  const topRows = top.map(([acc,cnt])=>{
    const pct = ((cnt / scanned) * 100).toFixed(2);
    return `
      <tr>
        <td class="mono">${escapeHtml(acc)}</td>
        <td class="right mono">${cnt}</td>
        <td class="right mono">${pct}%</td>
      </tr>
    `;
  }).join('');
  renderTableBody($('topHoldersTbl').querySelector('tbody'), topRows);

  // Origin -> owner sample (top pairs)
  const pairs = [...originToOwnerCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 12);
  const pairRows = pairs.map(([k,cnt])=>{
    const [origin, owner] = k.split("|");
    return `
      <tr>
        <td class="mono">${escapeHtml(origin)}</td>
        <td class="mono">${escapeHtml(owner)}</td>
        <td class="right mono">${cnt}</td>
      </tr>
    `;
  }).join('');
  renderTableBody($('originMapTbl').querySelector('tbody'), pairRows);

  // Summary text
  const distinctOwners = ownerCount.size;
  const distinctOrigins = new Set([...originToOwnerCount.keys()].map(k=>k.split("|")[0])).size;
  $('graphOut').innerHTML = `
    <div><span class="ok">Graph ready.</span> <span class="muted">Scanned ${scanned} segments.</span></div>
    <div class="muted">Distinct owners: <span class="mono">${distinctOwners}</span> · distinct origins: <span class="mono">${distinctOrigins}</span></div>
  `;
}

$('load').onclick = loadDashboard;
$('quickTest').onclick = quickTest;
$('reset').onclick = ()=>{
  $('nodesExtra').value = "";
  saveExtrasToStorage();
  loadDashboard();
};
$('next').onclick = async ()=>{ cursor += limit; await loadAccounts(); };
$('prev').onclick = async ()=>{ cursor = Math.max(0, cursor - limit); await loadAccounts(); };
$('viewAccount').onclick = ()=>viewAccount($('accountSearch').value.trim());
$('serialBtn').onclick = lookupSerial;
$('graphRefresh').onclick = refreshGraph;

// Auto-load on page open (primary hidden, always)
(function boot(){
  loadExtrasFromStorage();
  loadDashboard();
})();
</script>
</body>
</html>
